#!/usr/bin/env node
//github.com/GMTurbo/smasher/blob/master/smash.js
function printHelp(){var e=[["smash".red," --break".green," path/file.txt".cyan," --count".green," 5".cyan].join(" "),["smash".red," --join".green," path/file.txt".cyan,"<-- file name and extention must match chunks".grey].join(" ")];console.log(e.join("\n"))}var fs=require("fs"),path=require("path"),argv=require("minimist")(process.argv.slice(2)),StreamBouncer=require("stream-bouncer"),mkdirp=require("mkdirp"),colors=require("colors"),_bouncer=new StreamBouncer({streamsPerTick:1,poll:100}),createPath=function(e,r){var t=fs.statSync(e).isDirectory?e:path.dirname(r);return mkdirp.sync(t),t+"/"+path.basename(r)},_checkForOut=function(e){return argv.output?argv.output+"/":path.dirname(e)},_getOutputPath=function(e){var r=_checkForOut(e);return"/"!=r?r:(mkdirp.sync(path.dirname(e)+"/output/"),path.dirname(e)+"/output/")},_break=function(e,r){var t,n=require("chunking-streams"),a=n.SizeChunker,i=new a({chunkSize:fs.statSync(e).size/r,flushTail:!0});i.on("chunkStart",function(r,n){mkdirp.sync(_getOutputPath(e)),t=fs.createWriteStream(_getOutputPath(e)+"/"+path.basename(e)+"."+r),n()}),i.on("chunkEnd",function(e,r){t.end(),0==fs.statSync(t.path).size&&fs.unlink(t.path,function(e){e&&console.log(e)}),r()}),i.on("data",function(e){e.data.length&&t.write(e.data)}),_bouncer.push({source:fs.createReadStream(e),destination:i})},_join=function(e){var r=(require("random-access-file"),require("lodash")),t=function(e){var t,n=function(){if(t)return t;var n=fs.readdirSync(path.dirname(e));return n=r.filter(n,function(r){return-1!=r.indexOf(path.basename(e)+".")}),t=n.length||0};return n},n=t(e),a=createPath(_checkForOut(e),e);if(fs.existsSync(a))return void console.log(a+" already exists on disk : (");for(var i=0;i<n();i++){var o=e+"."+i;fs.existsSync(o)||(console.log(o+" missing :/"),process.exit()),_bouncer.push({source:fs.createReadStream(o),destination:fs.createWriteStream(a,{flags:"a"})})}};argv.break=argv.break,argv.join=argv.join,argv.break?_break(argv.break,argv.count||2):argv.join?_join(argv.join):printHelp();
