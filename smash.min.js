#!/usr/bin/env node
//github.com/GMTurbo/smasher/blob/master/smash.js
function printHelp(){var e=[["smash".red," --break".green," path/file.txt".cyan," --count".green," 5".cyan].join(" "),["smash".red," --join".green," path/file.txt".cyan,"<-- file name and extention must match chunks".grey].join(" ")];console.log(e.join("\n"))}var fs=require("fs"),path=require("path"),argv=require("minimist")(process.argv.slice(2)),StreamBouncer=require("stream-bouncer"),mkdirp=require("mkdirp"),colors=require("colors"),_=require("lodash"),_bouncer=new StreamBouncer({streamsPerTick:1,poll:100}),_getFileCount=function(e){var r,n=function(){if(r)return r;var n=fs.readdirSync(path.dirname(e));return n=_.filter(n,function(r){return-1!=r.indexOf(path.basename(e)+".")}),r=n.length||0};return n},createPath=function(e,r){var n=fs.statSync(e).isDirectory?e:path.dirname(r);return mkdirp.sync(n),n+"/"+path.basename(r)},_checkForOut=function(){return argv.output?argv.output+"/":"/"},_getOutputPath=function(e){var r=_checkForOut(e);return"/"!=r?r:(mkdirp.sync(path.dirname(e)+"/output/"),path.dirname(e)+"/output/")},_break=function(e,r){var n,t=require("chunking-streams"),a=t.SizeChunker,i=new a({chunkSize:fs.statSync(e).size/r,flushTail:!0});i.on("chunkStart",function(r,t){mkdirp.sync(_getOutputPath(e)),n=fs.createWriteStream(_getOutputPath(e)+"/"+path.basename(e)+"."+r),t()}),i.on("chunkEnd",function(e,r){n.end(),r()}),i.on("data",function(e){e.data.length&&n.write(e.data)}),_bouncer.on("close",function(){for(var r=_getOutputPath(e)+"/"+path.basename(e),n=_getFileCount(r),t=0;t<n();t++){var a=r+"."+t;fs.existsSync(a)?0==fs.statSync(a).size&&fs.unlink(a,function(e){e&&console.log(e)}):console.log(a+" missing :/")}}),_bouncer.push({source:fs.createReadStream(e),destination:i})},_join=function(e){var r=(require("random-access-file"),_getFileCount(e)),n=createPath(_checkForOut(e),e);if(fs.existsSync(n))return void console.log(n+" already exists on disk : (");for(var t=0;t<r();t++){var a=e+"."+t;fs.existsSync(a)?_bouncer.push({source:fs.createReadStream(a),destination:fs.createWriteStream(n,{flags:"a"})}):console.log(a+" missing :/")}};argv.break=argv.break,argv.join=argv.join,argv.break?_break(argv.break,argv.count||2):argv.join?_join(argv.join):printHelp();
